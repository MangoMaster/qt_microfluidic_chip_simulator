# Software Design Document 软件设计文档

Microfluidic Chip Simulator 软件  
魏家栋  2017011445  
2018年9月1日  

## 简介

#### 设计目标

一个基于Qt的Microfluidic Chip Simulator用户界面系统，实现芯片的手动/随机设计、芯片流速的计算与图形化显示。要求该软件界面基于QMainWindow，带有菜单栏和工具栏；基于鼠标和键盘事件实现芯片的手工设计；集成流速计算算法。

#### 适用范围

芯片结构均为正方形，边长最大为8，最小为5，管道为曼哈顿网格形。芯片有两个输入管道、三个输出管道，输入输出管道与芯片管道的交点都位于水平垂直网格的交点上，且所有输入输出管道必须相通。两个输入管道的液体流速为200个单位，左侧管道液体浓度为100%，右侧管道液体浓度为0%。计算过程采用近似算法，牺牲了一些准确度，但速度较快。

#### 版权

MIT License。软件由魏家栋设计，计算程序来自清华大学研究人员姚海龙和冀伟清。保留所有权利。

## 软件概述

该软件 Microfluidic Chip Simulator 允许用户在图形化界面上方便的调整芯片的大小、管道连通与否（通过手动或随机的方式）、管道的宽度，在给定条件下快速计算出输出管道液体的流速并显示在界面上。

## 软件结构

软件采用MVC（Model-View-Controller）设计模式，Model负责数值的存储和计算，View负责图形的显示，二者通过Controller进行交互，交互过程利用了Qt提供的信号槽（Signal-Slot）机制。这一设计模式同时得益于Qt绘图采用的Graphics View框架，可以方便的继承Qt已有的类和对象，减少了代码量，增加了代码的复用性。

#### Model 模块

主要包含类ChipModel、类Cube和计算过程calculate。ChipModel继承Qt的类QGraphicsScene，存储并管理大量的QGraphicsItem等图形信息，以及芯片的大小、输入输出管道所在的位置、计算结果等计算程序相关信息；Cube继承Qt的类QGraphicsItem，存储管道在界面上的位置、大小、画笔画刷等图形信息，以及管道连通与否、管道横截面的宽度等计算程序相关信息；计算过程calculate来自清华大学研究人员姚海龙和冀伟清，首先确定节点与管道的连接关系、管道横截面的宽度，然后类比液体流动和电流，通过基尔霍夫定律构建管道内液体流速的方程，最后解方程得到结果。  
ChipModel负责管理众多的Cube，并在合适的时候调用calculate进行计算。

#### View 模块

主要包含类MainWindow、类Chip。MainWindow继承Qt的类QMainWindow，是程序的主界面，包括菜单栏、工具栏、状态栏，中间部分显示芯片的大小、管道的连通状态、管道的宽度、输入输出管道的流速和浓度等。Chip继承Qt的类QGraphicsView，负责显示ChipModel存储的信息，并设定显示模式，如允许RubberBand拖动、进行显示缩放等。  
MainWindow的中间部分主要为一个Chip，用于显示芯片状态。

#### Controller 模块

主要包含类Controller。Controller继承Qt的类QObject，通过Qt提供的信号槽（Signal-Slot）机制，将Model模块和View模块相连。比如当用户点击“Run”按钮时，View模块发出 “run“ signal，Model模块通过对应slot接收到signal并进行相应的计算，再发出 “result” signal，View模块通过对应slot接收到signal并进行显示。

## 用户界面

菜单栏中点击“Help”选择“Help”项，或者工具栏中点击“问号”图标，可以获得该软件的使用帮助。  
菜单栏中点击“Chip”选择“New”项，或者工具栏中点击“加号”图标，或者按快捷键Ctrl+N，可以新建一个芯片。在弹出的对话框中选择芯片的节点数（最小值为5，最大值为8，否则无法进行选择）、两个输入管道和三个输出管道的位置（必须在芯片上，两个输入管道不重合，三个输出管道不重合，否则弹出对话框提示），新建芯片。  
在芯片上鼠标左键单机管道切换连通状态，管道连通显示为蓝色，管道不连通显示为背景颜色。  
在芯片上鼠标右键单机管道，在弹出的对话框中键入管道横截面的宽度（最小值20，最大值1600，否则无法进行选择），改变管道横截面宽度会改变其在芯片上的显示宽度。  
在芯片上按下鼠标左键或右键并拖拽，选中一些管道，在弹出的对话框中可以选择改变这些管道的连通状态（全部设为连通、全部设为不连通、不改变、反转连通状态）、横截面宽度（最小值20，最大值1600，否则无法进行选择）。该功能可以方便的对大量管道进行操作。  
拖动屏幕右侧中部的滑条，改变芯片的放缩比例（最大值180%，最小值20%）。  
菜单栏中点击“Chip”选择“Random”项，或者工具栏中点击“随机”图标，在弹出的对话框中输入比例，可以在当前芯片上按照该比例设定管道的连通率。它不会改变芯片的节点数多少，也不会改变芯片上管道的宽度。  
菜单栏中点击“Chip”选择“Run”项，或者工具栏中点击“运行”图标，或者按下界面下方中央偏右的“Run”按钮，或者按快捷键Ctrl+R，可以运行计算程序，并将输出管道的流速显示在界面下方中央。  
菜单栏中点击“Chip”选择“Exit”项，或者工具栏中点击“叉号”图标，或者按快捷键Ctrl+Q，或者关闭窗口，可以退出该程序。  
菜单栏中点击“Help”选择“About”项，或者工具栏中点击“惊叹号”图标，可以了解该软件的相关信息。

## 未来拓展

由于Qt大作业时间紧迫（只有一周），并且我之前并没有接触过Qt，自己的算法能力也确实有限，所以有许多拓展并没有来得及实现。  
+ 可自动跟随窗口大小调整显示大小的芯片。目前我只完成了通过滑动滑条手动调整芯片的显示大小，而在窗口大小改变时，芯片的显示大小并不会发生改变。该特点可能源于QGraphicsView和QGraphicsScene的解耦。
+ 通过鼠标拖拽调整管道宽度。现在可以通过右键单击管道设定其宽度，尽管这一方法更为精确，但并不方便用户操作。
+ 更复杂的管道横截面宽度判定。目前我将管道横截面宽度的最大值设定为一固定值，该固定最大值下相邻管道间距一定满足作业给定要求。未来可以考虑动态的管道横截面宽度最大值，使得只要相邻管道间距大于给定要求，就能够进行设定。甚至可以考虑在管道不连通时（不存在时），某一管道可以“占用”相邻管道的位置。
+ 更合适美观的界面设计。现在的界面常常容纳不下芯片的高度，长度反倒绰绰有余，管道的宽度设定的较窄时也不容易进行鼠标点击操作。
+ 液体浓度计算程序。目前我只将给出的流速计算程序集成到了软件中，并没有加入对液体浓度的计算。
+ 自动化芯片设计。用户给定输出流速/浓度，程序自动调整芯片的结构，满足用户给定的数值。